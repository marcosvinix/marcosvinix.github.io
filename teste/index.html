<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>League TD ‚Äì Summoner's Rift (HTML) ‚Äî Upgrades & Skill Trees</title>
<style>
  :root{--bg:#071018;--panel:#0f1736;--ink:#e6ecff;--muted:#9fb0d9;--accent:#6ee7ff;--gold:#ffd166}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071018,#07182a);color:var(--ink);font:500 14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .wrap{display:grid;grid-template-columns:1fr 360px;gap:12px;min-height:100dvh;padding:12px}
  canvas{width:100%;height:100%;border-radius:16px;image-rendering:pixelated;background:#09121a}
  .card{background:linear-gradient(180deg,#0b1530,#071226);border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(0,0,0,.6);border-radius:12px;padding:10px}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  h1{font-size:16px;margin:0}
  .row{display:flex;gap:8px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#0e1830;border:1px solid #21325a}
  #shop{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .champ-btn{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px solid #243165;background:#071937;cursor:pointer}
  .champ-swatch{width:18px;height:18px;border-radius:4px;border:1px solid #0004}
  .side-section{margin-top:10px}
  .upgrade-panel{display:grid;grid-template-columns:1fr;gap:8px}
  .skill-tree{display:flex;gap:8px}
  .path{flex:1;background:#081229;border:1px solid #16224a;padding:8px;border-radius:8px}
  .skill{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px dashed #1e2a50;background:linear-gradient(180deg,#07142a,#061225);cursor:pointer}
  .skill.locked{opacity:.5}
  .skill .dot{width:18px;height:18px;border-radius:3px}
  .skill .desc{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:8px}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid #26336b;background:#10204a;color:var(--ink);cursor:pointer}
  .small{font-size:12px;color:var(--muted)}
  .selectedBox{outline:2px solid rgba(110,231,255,0.12);box-shadow:0 6px 18px rgba(110,231,255,0.02)}
  .pixel-preview{background:#07122a;border-radius:8px;padding:6px;border:1px solid #14224a}
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="1280" height="720"></canvas>
  <div>
    <div class="card">
      <header>
        <h1>League TD ‚Äî Skill Trees</h1>
        <div class="row">
          <span class="pill" id="goldPill">Gold: 650</span>
          <span class="pill" id="livesPill">Nexus ‚ù§ 20</span>
          <span class="pill" id="wavePill">Wave 1</span>
        </div>
      </header>
      <div id="shop" class="side-section"></div>

      <div class="side-section card selectedBox" id="upgradeCard" style="margin-top:10px;display:none">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div>
            <div id="selName" style="font-weight:700">Selected</div>
            <div id="selInfo" class="small">Click a tower to view its skill tree</div>
          </div>
          <div class="pixel-preview" id="selPreview"></div>
        </div>
        <div style="margin-top:8px" class="small">Each champion has 3 skill paths with 3 patches. Unlock them sequentially. Skills add new visual FX and mechanical effects.</div>
        <div id="trees" style="margin-top:8px" class="upgrade-panel"></div>
        <div class="controls">
          <button id="upgradeBtn" class="btn">Apply Selected Patch</button>
          <button id="refundBtn" class="btn">Refund (R)</button>
        </div>
      </div>

      <div class="side-section" style="margin-top:14px">
        <div class="small">Controls: <span class="kbd">1‚Äì5</span> select champ, <span class="kbd">U</span> quick upgrade (first available), <span class="kbd">P</span> pause</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('game'); const ctx = cvs.getContext('2d'); const W=cvs.width,H=cvs.height;
  const goldEl=document.getElementById('goldPill'), livesEl=document.getElementById('livesPill'), waveEl=document.getElementById('wavePill');
  const shopEl=document.getElementById('shop'); const upgradeCard=document.getElementById('upgradeCard'); const treesEl=document.getElementById('trees');
  const selName=document.getElementById('selName'), selInfo=document.getElementById('selInfo'), selPreview=document.getElementById('selPreview');
  const upgradeBtn=document.getElementById('upgradeBtn'), refundBtn=document.getElementById('refundBtn');

  const state={gold:650,lives:20,wave:0,placing:null,towers:[],bullets:[],creeps:[],particles:[],shrooms:[],selected:null};

  // Champion base + skill trees
  const Champs = {
    ASHE: {
      name:'Ashe', cost:200, color:'#9ad0ff', draw:drawAshe,
      base:{range:150, fireRate:.9, dmg:12},
      tree:[
        [{id:'a1',name:'Winged Quiver+',desc:'+10% fire rate',cost:80,apply:t=>t.fireRate*=0.9,fx:()=>{}},{id:'a2',name:'Frostbite',desc:'+slow duration',cost:140,apply:t=>t.onHit=(c)=>{c.slow=Math.max(c.slow,1400);},fx:()=>{}},{id:'a3',name:'Enchanted Arrow',desc:'Chance to stun on crit',cost:260,apply:t=>t.ult=true,fx:()=>{}}],
        [{id:'b1',name:'Volley',desc:'Shoots 3 arrows',cost:140,apply:t=>t.multi=3,fx:()=>{}},{id:'b2',name:'Hawkshot',desc:'Increased vision, reveal stealth',cost:200,apply:t=>t.reveal=true,fx:()=>{}},{id:'b3',name:'Crystal Arrow+',desc:'Longer stun',cost:300,apply:t=>t.stunPlus=true,fx:()=>{}}],
        [{id:'c1',name:'Precision',desc:'+2 dmg',cost:100,apply:t=>t.dmg+=2,fx:()=>{}},{id:'c2',name:'Frost Nova',desc:'AoE slow on hit',cost:220,apply:t=>t.splash=40,fx:()=>{}},{id:'c3',name:'Arrow of Ages',desc:'Ultimate: global stun pulse',cost:420,apply:t=>t.globalUlt=true,fx:()=>{}}]
      ]
    },
    GAREN: {
      name:'Garen', cost:230, color:'#7cff6e', draw:drawGaren,
      base:{range:90, fireRate:.6, dmg:7},
      tree:[
        [{id:'a1',name:'Courage+',desc:'+dmg',cost:90,apply:t=>t.dmg+=2,fx:()=>{}},{id:'a2',name:'Tenacity',desc:'Spin reduces incoming dmg',cost:160,apply:t=>t.tenacity=true,fx:()=>{}},{id:'a3',name:'Demacian Might',desc:'Spin crits',cost:320,apply:t=>t.spinCrit=true,fx:()=>{}}],
        [{id:'b1',name:'Judgment',desc:'Spin faster',cost:120,apply:t=>t.spinFast=true,fx:()=>{}},{id:'b2',name:'Cleave',desc:'Spin hits wider',cost:200,apply:t=>t.spinWide=true,fx:()=>{}},{id:'b3',name:'Grand Execution',desc:'Execute mechanic',cost:380,apply:t=>t.execute=0.2,fx:()=>{}}],
        [{id:'c1',name:'Shield of Demacia',desc:'+HP shield on spawn',cost:110,apply:t=>t.shield=40,fx:()=>{}},{id:'c2',name:'Spin Burst',desc:'Leaves slow field',cost:210,apply:t=>t.spinField=true,fx:()=>{}},{id:'c3',name:'Warden',desc:'Spin generates particle orb',cost:340,apply:t=>t.orb=true,fx:()=>{}}]
      ]
    },
    LUX: {
      name:'Lux', cost:260, color:'#ffd166', draw:drawLux,
      base:{range:200, fireRate:1.2, dmg:10},
      tree:[
        [{id:'a1',name:'Lucent Minor',desc:'+splash on hit',cost:100,apply:t=>t.splash=36,fx:()=>{}},{id:'a2',name:'Prismatic Shield',desc:'Shield allies (passive)',cost:180,apply:t=>t.shieldAlly=true,fx:()=>{}},{id:'a3',name:'Final Spark+',desc:'Laser +dmg',cost:360,apply:t=>t.laserPlus=true,fx:()=>{}}],
        [{id:'b1',name:'Binding Light',desc:'Root small chance',cost:120,apply:t=>t.rootChance=0.08,fx:()=>{}},{id:'b2',name:'Refraction',desc:'Beam pierces',cost:220,apply:t=>t.beamPierce=true,fx:()=>{}},{id:'b3',name:'Radiance',desc:'Beam cleaves',cost:380,apply:t=>t.beamCleave=true,fx:()=>{}}],
        [{id:'c1',name:'Lux Aegis',desc:'+1 dmg',cost:90,apply:t=>t.dmg+=1,fx:()=>{}},{id:'c2',name:'Glimmer',desc:'Crit chance on beam',cost:200,apply:t=>t.beamCrit=0.07,fx:()=>{}},{id:'c3',name:'Lightbringer',desc:'Massive beam ult',cost:420,apply:t=>t.massBeam=true,fx:()=>{}}]
      ]
    },
    JINX: {
      name:'Jinx', cost:240, color:'#ff77b6', draw:drawJinx,
      base:{range:170, fireRate:.85, dmg:9},
      tree:[
        [{id:'a1',name:'Pow-Pow',desc:'AS +15%',cost:110,apply:t=>t.fireRate*=0.85,fx:()=>{}},{id:'a2',name:'Switcheroo',desc:'Rockets deal splash',cost:180,apply:t=>t.splash=48,fx:()=>{}},{id:'a3',name:'Riot Mode',desc:'AS burst on kill',cost:360,apply:t=>t.burstOnKill=true,fx:()=>{}}],
        [{id:'b1',name:'Fishbones+',desc:'Rocket bigger',cost:130,apply:t=>t.rocketBig=true,fx:()=>{}},{id:'b2',name:'Zap!',desc:'Chain lightning proc',cost:200,apply:t=>t.chain=true,fx:()=>{}},{id:'b3',name:'Super Mega',desc:'Giant rocket ulti',cost:420,apply:t=>t.mega=true,fx:()=>{}}],
        [{id:'c1',name:'Gremlin',desc:'+1 dmg',cost:90,apply:t=>t.dmg+=1,fx:()=>{}},{id:'c2',name:'Explosive Rounds',desc:'Rockets apply burn',cost:210,apply:t=>t.burnSplash=true,fx:()=>{}},{id:'c3',name:'Chaos',desc:'Random rockets at interval',cost:380,apply:t=>t.chaos=true,fx:()=>{}}]
      ]
    },
    TEEMO: {
      name:'Teemo', cost:180, color:'#9df27b', draw:drawTeemo,
      base:{range:120, fireRate:1.1, dmg:6},
      tree:[
        [{id:'a1',name:'Toxic Shot+',desc:'+2 dmg',cost:90,apply:t=>t.dmg+=2,fx:()=>{}},{id:'a2',name:'Guerrilla',desc:'Shrooms slow',cost:160,apply:t=>t.shSlow=true,fx:()=>{}},{id:'a3',name:'Noxious Trap+',desc:'Bigger shrooms',cost:340,apply:t=>t.bigShroom=true,fx:()=>{}}],
        [{id:'b1',name:'Camouflage',desc:'Hidden when idle',cost:120,apply:t=>t.camouflage=true,fx:()=>{}},{id:'b2',name:'Toxic Cloud',desc:'Shrooms leave cloud',cost:220,apply:t=>t.cloud=true,fx:()=>{}},{id:'b3',name:'Shroom King',desc:'Shrooms explode',cost:380,apply:t=>t.explodeShroom=true,fx:()=>{}}],
        [{id:'c1',name:'Mushroom Lore',desc:'+shroom dmg',cost:100,apply:t=>t.shroomDmg+=3,fx:()=>{}},{id:'c2',name:'Spore Burst',desc:'Shrooms release spores on death',cost:210,apply:t=>t.spores=true,fx:()=>{}},{id:'c3',name:'Monarch of Decay',desc:'Shrooms petrify',cost:420,apply:t=>t.petrify=true,fx:()=>{}}]
      ]
    }
  };

  // create shop UI
  const champKeys = Object.keys(Champs);
  champKeys.forEach((k,i)=>{
    const ch=Champs[k]; const b=document.createElement('button'); b.className='champ-btn'; b.innerHTML=`<div style="width:18px;height:18px;background:${ch.color};border-radius:3px"></div><div style="flex:1;text-align:left">${ch.name}</div><div class="small">$${ch.cost}</div>`;
    b.onclick=()=>state.placing=k; shopEl.appendChild(b);
  });

  // keyboard shortcuts
  window.addEventListener('keydown',e=>{ if(e.key>='1'&&e.key<='5'){ state.placing=champKeys[Number(e.key)-1]; } if(e.key==='p'||e.key==='P'){ paused=!paused; } if(e.key==='u'||e.key==='U'){ quickUpgrade(); } if(e.key==='r'||e.key==='R'){ refundSelected(); } });

  // map & path (simplified)
  const path=[{x:60,y:680},{x:200,y:600},{x:340,y:520},{x:460,y:480},{x:560,y:420},{x:680,y:360},{x:800,y:300},{x:920,y:240},{x:1040,y:180},{x:1180,y:120}]; const nexus={x:1220,y:100};

  function drawTerrain(){
    // grass
    ctx.fillStyle='#071217'; ctx.fillRect(0,0,W,H);
    // path band
    ctx.lineWidth=36; ctx.lineCap='round'; ctx.strokeStyle='#2b2b2b'; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(let p of path) ctx.lineTo(p.x,p.y); ctx.stroke();
    ctx.lineWidth=24; ctx.strokeStyle='#5f5138'; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(let p of path) ctx.lineTo(p.x,p.y); ctx.stroke();
    // nexus pixel
    drawPixelNexus(nexus.x,nexus.y);
  }

  function drawPixelNexus(x,y){ const s=3; const px=['........','..88A8..','.8AAA88.','.8A99A8.','.8AAA88.','..88A8..','...88...','...66...']; for(let j=0;j<px.length;j++){ for(let i=0;i<px[j].length;i++){ const c=px[j][i]; if(c=='.') continue; ctx.fillStyle = c==='8'? '#7db2ff' : (c==='A'? '#cde8ff' : (c==='9'?'#a1d4ff':'#5ad1ff')); ctx.fillRect(x+i*s-12,y+j*s-12,s,s); } } }

  // creeps
  const CreepKinds={red:{hp:25,speed:48,reward:7,color:'#d94b4b'},blue:{hp:40,speed:56,reward:8,color:'#4b7fd9'},cannon:{hp:150,speed:42,reward:20,color:'#bdbdbd'},redBuff:{hp:600,speed:50,reward:60,color:'#c04a2b',boss:true}};
  function makeCreep(kind){ const k=CreepKinds[kind]; return {kind, ...JSON.parse(JSON.stringify(k)), x:path[0].x, y:path[0].y, seg:0, slow:0,burn:0,stun:0,alive:true}; }

  // placement & selection
  const mouse={x:0,y:0}; cvs.addEventListener('mousemove',e=>{ const r=cvs.getBoundingClientRect(); mouse.x=(e.clientX-r.left)*W/r.width; mouse.y=(e.clientY-r.top)*H/r.height; }); cvs.addEventListener('click',e=>{ placeOrSelect(); });

  function placeOrSelect(){ const clicked = state.towers.find(t=>Math.hypot(mouse.x-t.x,mouse.y-t.y)<18); if(clicked){ state.selected=clicked; openUpgradeFor(clicked); return; } if(!state.placing) return; const ch=Champs[state.placing]; if(state.gold<ch.cost) return; if(!validBuild(mouse.x,mouse.y)) return; const t=createTower(state.placing, mouse.x, mouse.y); state.towers.push(t); state.gold-=ch.cost; updateUI(); }

  function validBuild(x,y){ if(x<40||y<40||x>W-40||y>H-40) return false; for(let i=0;i<path.length-1;i++){ const p0=path[i], p1=path[i+1]; if(pointSegDist(x,y,p0.x,p0.y,p1.x,p1.y)<40) return false; } return !state.towers.some(t=>Math.hypot(t.x-x,t.y-y)<36);
  }

  function pointSegDist(x,y,x1,y1,x2,y2){ const A=x-x1,B=y-y1,C=x2-x1,D=y2-y1; const dot=A*C+B*D; const len=C*C+D*D; let t=-1; if(len!==0) t=dot/len; t=Math.max(0,Math.min(1,t)); const nx=x1+t*C, ny=y1+t*D; return Math.hypot(x-nx,y-ny); }

  function createTower(key,x,y){ const ch=Champs[key]; const base=JSON.parse(JSON.stringify(ch.base)); return {x:Math.round(x),y:Math.round(y),key,name:ch.name,color:ch.color,range:base.range,fireRate:base.fireRate,dmg:base.dmg,draw:ch.draw,tree:JSON.parse(JSON.stringify(ch.tree)),upgrades:[],cd:0,spent:ch.cost}; }

  // open upgrade UI
  function openUpgradeFor(t){ upgradeCard.style.display='block'; selName.textContent = t.name; selInfo.textContent = `Level ${t.upgrades.length} ‚Ä¢ Gold: $${state.gold}`; selPreview.innerHTML=''; const px=document.createElement('canvas'); px.width=48; px.height=48; px.style.width='48px'; px.style.height='48px'; const pctx=px.getContext('2d'); pctx.imageSmoothingEnabled=false; // draw big pixel
    // draw small pixel art preview
    pctx.fillStyle='#0000'; pctx.fillRect(0,0,48,48); t.draw(pctx,24,24,4); selPreview.appendChild(px);
    renderTrees(t);
  }

  function renderTrees(t){ treesEl.innerHTML=''; const treeWrap=document.createElement('div'); treeWrap.className='skill-tree'; t.tree.forEach((pathArr,pathIdx)=>{ const pathEl=document.createElement('div'); pathEl.className='path'; pathArr.forEach((skill,skIdx)=>{ const div=document.createElement('div'); div.className='skill '+(t.upgrades.includes(skill.id)?'unlocked':'locked'); div.innerHTML=`<div class="dot" style="background:${getPathColor(pathIdx)}"></div><div style="flex:1"><div style="font-weight:700">${skill.name}</div><div class="desc">${skill.desc} ‚Äî $${skill.cost}</div></div><div style="width:22px;text-align:center">${t.upgrades.includes(skill.id)?'‚úì': (t.upgrades.includes(pathArr[skIdx-1]?.id) || skIdx===0 ? '‚óè':'üîí')}</div>`;
      div.onclick = ()=>{ trySelectSkill(t, skill, pathIdx, skIdx); };
      pathEl.appendChild(div);
    }); treeWrap.appendChild(pathEl); }); treesEl.appendChild(treeWrap);
  }

  function getPathColor(i){ return ['#6ee7ff','#7cff6e','#ffd166'][i]||'#9fb0d9'; }

  let selectedSkill = null; function trySelectSkill(t, skill, pidx, sidx){ // verify prerequisites
    const prev = sidx===0 ? true : t.upgrades.includes(t.tree[pidx][sidx-1].id);
    if(!prev) return; selectedSkill = {t,skill,pidx,sidx}; // highlight
    upgradeBtn.textContent = `Buy: ${skill.name} ‚Äî $${skill.cost}`;
    upgradeBtn.onclick = ()=>applySelectedSkill();
  }

  function applySelectedSkill(){ if(!selectedSkill) return; const {t,skill} = selectedSkill; if(state.gold < skill.cost) return; state.gold -= skill.cost; t.upgrades.push(skill.id); // apply effect
    if(skill.apply) skill.apply(t); // add spent
    t.spent = (t.spent||0) + skill.cost; updateUI(); openUpgradeFor(t); selectedSkill=null; }

  function quickUpgrade(){ const t=state.selected; if(!t) return; // find first purchasable skill
    for(let p=0;p<t.tree.length;p++){ for(let s=0;s<t.tree[p].length;s++){ const sk=t.tree[p][s]; const prev = s===0?true:t.upgrades.includes(t.tree[p][s-1].id); if(prev && !t.upgrades.includes(sk.id) && state.gold>=sk.cost){ selectedSkill={t,skill:sk}; applySelectedSkill(); return; } } } }

  function refundSelected(){ const t=state.selected; if(!t) return; const refund=Math.floor((t.spent||0)*0.7); state.gold += refund; state.towers = state.towers.filter(x=>x!==t); state.selected=null; upgradeCard.style.display='none'; updateUI(); }

  refundBtn.onclick = refundSelected;

  function updateUI(){ goldEl.textContent = `Gold: ${state.gold}`; livesEl.textContent = `Nexus ‚ù§ ${state.lives}`; }

  // drawing pixel champion functions (improved: accept ctx and scale)
  function drawAshe(ctx,x,y,scale=1){ pixelChar(ctx,x,y,scale,[ '...44..','..4774.','.477774','.47aa74','.477774','..4aa4.','...44..'],{4:'#9ad0ff',7:'#5d7fb8',a:'#cfe7ff'}); }
  function drawGaren(ctx,x,y,scale=1){ pixelChar(ctx,x,y,scale,['..77..','.7997.','79aa97','79aa97','.7997.','..77..','..55..'],{7:'#7cff6e',9:'#356f3b',a:'#a6ff99',5:'#3c515e'}); }
  function drawLux(ctx,x,y,scale=1){ pixelChar(ctx,x,y,scale,['..ee..','.e99e.','e9aa9e','e9aa9e','.e99e.','..ee..','..55..'],{e:'#ffd166',9:'#915f1a',a:'#fff2b0',5:'#3c3f6b'}); }
  function drawJinx(ctx,x,y,scale=1){ pixelChar(ctx,x,y,scale,['..pp..','.p66p.','p6aa6p','p6aa6p','.p66p.','..pp..','..55..'],{p:'#ff77b6',6:'#b74380',a:'#ffc3dd',5:'#3c3f6b'}); }
  function drawTeemo(ctx,x,y,scale=1){ pixelChar(ctx,x,y,scale,['..gg..','.g88g.','g8aa8g','g8aa8g','.g88g.','..gg..','..55..'],{g:'#9df27b',8:'#5aa83f',a:'#caffb3',5:'#3c3f6b'}); }

  function pixelChar(ctx,x,y,scale,rows,palette){ const s=3*scale; const w=rows[0].length,h=rows.length; ctx.save(); ctx.imageSmoothingEnabled=false; for(let j=0;j<h;j++){ for(let i=0;i<w;i++){ const k=rows[j][i]; if(k==='.'||!palette[k]) continue; ctx.fillStyle=palette[k]; ctx.fillRect(Math.round(x + (i - w/2)*s), Math.round(y + (j - h/2)*s), s, s); } } ctx.restore(); }

  // tower firing & effects (simplified additions)
  function towerTick(t,dt,now){ if(t.onTick) t.onTick(t,dt,now); t.cd-=dt; if(t.cd>0) return; const target=lockFirstInRange(t); if(!target) return; const shots = t.multi||1; for(let i=0;i<shots;i++){ fire(t,target,i); } t.cd=1000*t.fireRate; }
  function fire(t,target,i){ const ang=Math.atan2(target.y-t.y,target.x-t.x); const speed= t.projSpd||320; const b={x:t.x,y:t.y,vx:Math.cos(ang)*speed,vy:Math.sin(ang)*speed,dmg:t.dmg||1,owner:t,ttl:2500}; state.bullets.push(b); }
  function lockFirstInRange(t){ let best=null,bestSeg=-1; for(const c of state.creeps){ if(!c.alive) continue; const d=Math.hypot(t.x-c.x,t.y-c.y); if(d<=t.range){ if(c.seg>bestSeg){ best=c; bestSeg=c.seg; } } } return best; }

  // bullets/resolution + fx
  function stepBullets(dt){ for(const b of state.bullets){ b.x+=b.vx*dt/1000; b.y+=b.vy*dt/1000; b.ttl-=dt; for(const c of state.creeps){ if(!c.alive) continue; if(Math.hypot(b.x-c.x,b.y-c.y)<16){ damageCreep(c,b.dmg); // champion onHit triggers
        if(b.owner && b.owner.onHit) b.owner.onHit(c,b.owner); b.dead=true; break; } } } state.bullets=state.bullets.filter(b=>!b.dead && b.ttl>0); }
  function damageCreep(c,dmg){ c.hp-=dmg; state.particles.push({x:c.x,y:c.y,life:250}); if(c.hp<=0){ c.alive=false; state.gold += CreepKinds[c.kind].reward; updateUI(); } }

  // basic game loop
  let last=performance.now(),acc=0; const TICK=1000/60; let paused=false; function loop(ts){ const dt=Math.min(60,ts-last||0); last=ts; if(!paused){ acc+=dt; while(acc>=TICK){ step(TICK); acc-=TICK; } } draw(); requestAnimationFrame(loop); }
  function step(dt){ for(const c of state.creeps){ if(c.alive) moveCreep(c,dt); } state.creeps=state.creeps.filter(c=>c.alive); const now=performance.now(); for(const t of state.towers) towerTick(t,dt,now); stepBullets(dt); }

  function moveCreep(c,dt){ const p0=path[c.seg], p1=path[c.seg+1]; if(!p1){ c.alive=false; state.lives--; updateUI(); return; } const spd=c.speed*(c.slow>0?0.6:1); const step=spd*dt/1000; const vx=p1.x-c.x, vy=p1.y-c.y, d=Math.hypot(vx,vy)||1; c.x+=vx/d*step; c.y+=vy/d*step; if(Math.hypot(p1.x-c.x,p1.y-c.y)<2) c.seg++; if(c.slow>0) c.slow-=dt; if(c.burn>0){ c.burn-=dt; if(Math.random()<0.2) damageCreep(c,1); } }

  // waves (simpler spawner)
  const waveBook=[{list:['red','red','blue','red','cannon'],rate:650},{list:['blue','blue','red','cannon','blue'],rate:600},{list:['red','blue','cannon','redBuff'],rate:700}]; let spawner=null;
  function nextWave(){ if(spawner) return; state.wave++; waveEl.textContent=`Wave ${state.wave}`; const w=waveBook[(state.wave-1)%waveBook.length]; let i=0; spawner=setInterval(()=>{ if(i>=w.list.length){ clearInterval(spawner); spawner=null; return; } state.creeps.push(makeCreep(w.list[i++])); }, w.rate); }

  // draw
  function draw(){ ctx.clearRect(0,0,W,H); drawTerrain(); for(const s of state.shrooms) drawShroom(s); for(const c of state.creeps){ drawCreep(c); } for(const t of state.towers){ t.draw(ctx,t.x,t.y,2); if(state.selected===t) drawRange(t); } for(const b of state.bullets){ ctx.fillStyle='#fff'; ctx.fillRect(b.x-2,b.y-2,4,4); } for(const p of state.particles){ ctx.fillStyle='#fff'; ctx.fillRect(p.x-1,p.y-1,2,2); p.life-=16; } state.particles=state.particles.filter(p=>p.life>0); }

  function drawRange(t){ ctx.save(); ctx.strokeStyle='rgba(110,231,255,0.12)'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.arc(t.x,t.y,t.range,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
  function drawCreep(c){ ctx.fillStyle=c.color; ctx.beginPath(); ctx.arc(c.x,c.y,12,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#0008'; ctx.fillRect(c.x-12,c.y-16,24,4); ctx.fillStyle='#7cff6e'; const hpw=Math.max(0,24*c.hp/CreepKinds[c.kind].hp); ctx.fillRect(c.x-12,c.y-16,hpw,4); }
  function drawShroom(s){ ctx.fillStyle='rgba(160,255,120,0.12)'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#9df27b'; ctx.fillRect(s.x-3,s.y-3,6,6); }

  // create initial UI buttons
  const startBtn=document.createElement('button'); startBtn.className='btn'; startBtn.textContent='Start Wave'; startBtn.onclick=nextWave; shopEl.parentElement.appendChild(startBtn);

  // helper to update
  updateUI(); requestAnimationFrame(loop);

  // utility to draw pixel art onto small canvas context (for preview)
  // Add minimal interactivity for upgrade card
})();
</script>
</body>
</html>
